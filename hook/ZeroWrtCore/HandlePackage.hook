#!/bin/bash
# Copyright (C) 2000 ZeroDream

# --------------------------------------------------

cd "$WRT_MainPath/"

# --------------------------------------------------

# ! 由 ZeroDream 私有

[[ -z "$ZeroDream_Secret" ]] && exit 0

# 创建配置文件
touch "$CI_ConfigPath/TempConfig"
touch "$CI_ConfigPath/VirtualConfig"

# 备份配置
cat "$WRT_ConfigPath" >"$CI_ConfigPath/TempConfig"

# 生成初步的虚拟配置
make defconfig -j$(nproc) && make clean -j$(nproc)
cat "$WRT_ConfigPath" >"$CI_ConfigPath/VirtualConfig"

# 生成最终的虚拟配置
virtualConfig=$("$ZD_AppPath/EnableLuciAppConfig-linux-amd64" --configPath "$CI_ConfigPath/VirtualConfig")
(($? != 0)) && [[ "$ZD_Owner" == "$CI_Owner" ]] && exit 2
cat "$CI_ConfigPath/TempConfig" >"$WRT_ConfigPath" # 读取配置
echo '# LuciApp' >>"$WRT_ConfigPath"
echo "$virtualConfig" >>"$WRT_ConfigPath"
echo '# VirtualConfig' >>"$WRT_ConfigPath"
cat "$GITHUB_WORKSPACE/config/VirtualConfig" >>"$WRT_ConfigPath"
make defconfig -j$(nproc) && make clean -j$(nproc)
cat "$WRT_ConfigPath" >"$CI_ConfigPath/VirtualConfig"

# 还原配置
cat "$CI_ConfigPath/TempConfig" >"$WRT_ConfigPath"

# --------------------------------------------------

exit 0
